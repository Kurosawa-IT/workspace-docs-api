# ADR0002: 認証方式選定

Status: Accepted  
Date: 2026-02-21

## Context

本プロジェクトはAPI主体の「ワークスペース型ドキュメント管理SaaS」を想定している。
認証は以下を満たす必要がある。

- APIクライアント（Web/CLI等）から扱いやすい
- サーバ側でセッション状態を持たずにスケールしやすい
- /auth/me で「現在のユーザー」を取得できる
- 認証失敗時に情報漏えいを起こしにくい

## Decision

認証方式として JWT（Bearer Token）を採用する。

- ログイン成功時に `access_token` を発行し、以後は `Authorization: Bearer <token>` で送る
- JWT署名方式はHS256を採用する（現時点では外部IdP連携なし・単一サービス想定）
- トークンの最低クレームは `sub`（user_id）と `exp`（有効期限）を必須とする
- `GET /auth/me` はBearerトークン必須で、トークンの `sub` からDB上のユーザーを解決して返す
- 認証エラーは原則401で統一し、ユーザーの存在有無などを過度に漏らさない

設定値（例）:

- `JWT_SECRET_KEY`: HS256に十分な長さ（最低32バイト以上）
- `ACCESS_TOKEN_EXPIRE_MINUTES`: 例60分
- `JWT_ALGORITHM`: HS256

## Consequences

メリット:

- サーバ側でセッション状態を保持しないため水平スケールしやすい
- APIクライアントから扱いやすく、/auth/me 等の保護が簡単
- 署名とexpにより改ざん・期限切れを検知できる

デメリット/注意点:

- トークン失効（ログアウトや強制失効）を厳密にやるには追加設計が必要（ブラックリスト、トークンローテーション等）
- `JWT_SECRET_KEY` の漏洩は重大事故になり得るため、環境変数/Secret管理が必須
- 長期運用では鍵ローテーション、refresh token導入の検討が必要

## セキュリティ方針（最小）

- HS256鍵は最低32バイト以上（短い鍵は警告対象）
- トークンはHTTPS前提で運ぶ（平文通信は許容しない）
- /auth/login のエラーは「Invalid credentials」で統一し、メールの存在などを漏らしにくくする
- /auth/me は token decode + DB存在確認まで行う（削除ユーザー等のトークンを弾く）

## Alternatives

- Cookieセッション（サーバ側セッションストア）
  - Web中心なら扱いやすいが、API/CLI用途や水平スケールでセッション管理が増える
- JWT（RS256）/外部IdP
  - 将来的には拡張可能だが、現時点のスコープでは過剰
